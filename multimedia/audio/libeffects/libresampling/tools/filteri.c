/*****************************************************************************/
/*
 * Copyright (C) ST-Ericsson SA 2009,2010. All rights reserved.
 * This code is ST-Ericsson proprietary and confidential.
 * Any use of the code for whatever purpose is subject to
 * specific written permission of ST-Ericsson SA.
 *
 */

/**
 * \file   filter.c
 * \brief  
 * \author ST-Ericsson
 */
/*****************************************************************************/

#include <stdio.h>
#include <math.h>
#include <stdlib.h>
#include <ctype.h>
#include <string.h>
#define MAXCOEFS 2000
int main(int argc, char *argv[] )
{
	FILE *fin,*fout,*fnum;
	double MAXACCU_VAL,MAXCOEFS_VAL,numf[MAXCOEFS];
	long long node,node1;
	int  found,multi,num[MAXCOEFS],num1[MAXCOEFS],Dn[MAXCOEFS],shift,shiftval;
	int coefshift=0;
	int indx1,indx2;
	double mult,sumval,dtemp;
	float xtemp,maxlvl,value,gain;
	int skip=0,bigend=1,nbytes_data=2,nbytes_coefs=3,ibuf,itemp,i,coefnum,datanum,datavalid,iir=0,numcells=0,M=1,L=1,state;
	unsigned char cbuf;
	if ((argc!=5)&&(argc!=10))
	{
		printf("\n\n********* PARAMETER ERROR *********");
		printf("\n\n filteri INFILE  OUTFILE [ENDIENESS NBYTESdata NBYTEScoefs coefshift M L] NUMFILE \n");
		printf(" INFILE OUTFILE are binary files containing audio samples\n");
		printf(" [ENDIENESS b(def) or l  NBYTESdata 1,2(def),3,4 NBYTEScoefs 1,2,3(def),4 coefshift(def 0) M(def 1) L(def 1)]\n");
		printf(" coefshift is the desired shift value for low level coefficients to improve THD \n");
		printf(" NUMFILE  txt file contain floating point fir filter coefficients\n");
		printf(" coefficents are generated by Matlab program calcfilt.m\n");
		exit(1);
	}
	//------------------------ Open binary input and output audio files -----------
	if ((fin=fopen(argv[1],"rb"))==0)
	{
		printf("\n\n********** BAD INPUT FILE NAME  **********\n\n");
		exit(1);
	}
	fout=fopen(argv[2],"wb");
	if (argc==10)
	{
		skip=6;
		if (argv[3][0]=='l') bigend=0;
		nbytes_data=atoi(argv[4]);
		nbytes_coefs=atoi(argv[5]);
		coefshift=atoi(argv[6]);
		M=atoi(argv[7]);
		L=atoi(argv[8]);
	}
	//--------- Open txt filter numerator  coefficient file ------- 
	if ((fnum=fopen(argv[3+skip],"rt"))==0)
	{
		printf("\n\n********** BAD NUMFILE NAME  **********\n\n");
		exit(1);
	}
	MAXCOEFS_VAL=pow(2.0,(double)(nbytes_coefs*8-1));
	MAXACCU_VAL=pow(2.0,(double)(2*nbytes_coefs*8-1));
	//--------- Clear delay line and all coefficients -----------------------
	for (i=0;i<MAXCOEFS;i++)
	{
		Dn[i]=0;
		num[i]=0;
		num1[i]=0;
	}
	//---------- Read filter numerator coefficients ----------------------
	datavalid=1;
	i=0;
	while (datavalid==1)
	{
		datavalid=fscanf(fnum,"%e16.10\n",&xtemp);
		if (datavalid!=1) break;
		numf[i]=(double)xtemp;
		i++;
	}
	numcells=i;
	//---------- Normalize the coefficients for interpolation addition of zeros -----
	maxlvl=1e-6;
	for (i=0;i<numcells;i++)
	{
		if ((float)numf[i]>maxlvl) maxlvl=(float)numf[i];
	}
	//---------- Quantize the coefficients ------------------------------------------
	value = maxlvl;
	shiftval = 0;
	while( value > 1)
	{
  		shiftval--;
  		value/=2;
	}
	while( value < 0.5 )
	{
		shiftval++;
  		value*=2;
	}
	gain=(float)pow(2.,(double)shiftval);
	maxlvl=1e-6;
	indx1=0;
	found=0;
	for (i=0;((i<numcells)&&(found==0));i++)
	{
		xtemp=fabs(gain*(float)numf[i]);
		if (xtemp>maxlvl) maxlvl=xtemp;
		if (maxlvl*(float)pow(2.,(double)coefshift)>value)
		{
			found=1;
			indx1=i;
		}
	}
	indx2=numcells-indx1;
	sumval=0.0;
	for (i=0;i<numcells;i++)
	{
		xtemp=(float)numf[i];
		xtemp*=gain;
		sumval+=(double)xtemp;
		if ((i>indx1)&&(i<indx2))
		{
			num[i]=(int)((double)xtemp*MAXCOEFS_VAL);
		}
		else //boost low level coefficients to gain some THD
		{
			num1[i]=(int)((double)xtemp*MAXCOEFS_VAL*pow(2.,(double)coefshift));
			if (abs(num1[i])>(int)MAXCOEFS_VAL) printf("coef saturations\n");
		}
	}
	if ((numcells%M)!=0)
		numcells=(numcells/M)+1;
	else
		numcells=numcells/M;
	datavalid=1;
	state=M;
	//--------------------- Find shift and scale ----------------------
/*
	k=2^round(log2(1/sum(vector)));
	k=k*nbPhases;
	shift=ceil(log2(k));
	mult=k/(2^shift);
*/
	dtemp=log10(1./sumval)/log10(2.);
	if (dtemp<0) 
	{
		dtemp=-dtemp;
		dtemp=pow(2.,-(double)((int)(dtemp+.5)));
	}
	else
	{
		dtemp=pow(2.,(double)((int)(((log10(1./sumval))/log10(2.))+.5)));
	}
	dtemp*=(double)M;
	shift=(int)(1.+(log10(dtemp)/log10(2.)));
	mult=dtemp/(pow(2.,(double)shift));
	multi=(int)(mult*MAXCOEFS_VAL);
	//--------------- Filter all the samples ----------------------------
	while (datavalid==1)
	{
		if (state>=M)
		{
			//-------- Read 1 sample ----------------
			itemp=0;
			for (i=0;i<nbytes_data;i++)
			{
				cbuf=fgetc(fin);
				if (bigend==0)
				{
					itemp+=(int)cbuf<<((i+4-nbytes_data)*8);
				}
				else
				{
					itemp+=(int)cbuf<<((3-i)*8);
				}
			}
			itemp>>=(32-8*nbytes_data);
			ibuf=(int)itemp;
			if (feof(fin)) datavalid=0;
			if (datavalid!=1) break;
			for (i=numcells-1;i>=1;i--)
				Dn[i]=Dn[i-1];
			Dn[0]=(int)(((long long)ibuf*(long long)multi)>>(nbytes_coefs*8-1));
			state-=M;
		}
		else //if state<M
		{
			node=0;
			node1=0;
			for (i=0;i<numcells;i++)
			{
				node+=(((long long)Dn[i])*(long long)num[state+M*i]);
				node1+=(((long long)Dn[i])*(long long)num1[state+M*i]);
			}
			if (shift<0)
			{
				node>>=(-shift);
				node1>>=(-shift);
			}
			else
			{
				node<<=shift;
				node1<<=shift;
			}
			if (abs(node1)>(long long)MAXACCU_VAL) printf("accu saturations\n");
			node=node+(node1>>coefshift);
			ibuf=(int)(node>>(nbytes_coefs*8-1));
			//--------- Write 1 sample -------------
			for (i=0;i<nbytes_data;i++)
			{
				if (bigend==0)
				{
					cbuf=ibuf>>(i*8); 
				}
				else
				{
					cbuf=ibuf>>((nbytes_data-1-i)*8);
				}
				fputc(cbuf,fout);
			}
			state+=L;
		}//if state<M
	}
	fclose(fin);
	fclose(fout);
	fclose(fnum);
	return 0;
}

