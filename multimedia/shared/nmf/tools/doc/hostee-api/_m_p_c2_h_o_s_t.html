<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>NMF Host Execution Engine Documentation: NMF MPC-&gt;Host binding</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
<small><b>
<a href="http://www.stericsson.com"><img src="logo.jpg" width=220 height=68></a>
 WMM/MCP/MMD <a href="https://codex.cro.st.com/projects/nmf/">Nomadik Multiprocessing Framework</a>
</b></small>
</head><body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="MPC2HOST">NMF MPC-&gt;Host binding </a></h1><h2><a class="anchor" id="MPC2HOST_Data">
Data structures</a></h2>
<p>The following picture shows data structures put in place for MPC -&gt; Host (kernel or user) Binding. Like for architecture view, boxes in:</p>
<ul>
<li>Dark green color show data structure allocated by CM Engine component and by CM Proxy.</li>
<li>Light blue color show data structure allocated by OS wrapping layer. The prupose of this layer was to overload upper layer THIS contextby OS one in order to demultiplex incoming call and push corresponding event in the message queue of the process which has created the binding.</li>
</ul>
<div align="center">
<img src="inline_dotgraph_2.dot.png" alt="inline_dotgraph_2.dot" border="0" usemap="#inline_dotgraph_2.dot.map">
<map name="inline_dotgraph_2.dot.map" id="inline_dotgraph_2.dot.map"></map>
</div>
<p>In this data structure, you can show that either OS wrapper and skeleton data structure keep handle mpc2hostId. In Mpc-&gt;User binding only OS wrapper use it and in Mpc-&gt;Host binding only skeleton use it, thus for optimization purpose only required reference could be kept.</p>
<h2><a class="anchor" id="MPC2HOST_Sequence">
Sequence chart</a></h2>
<p>Sequence chart for creating a MPC -&gt; Host binding was:</p>
<ul>
<li>Client code creates THIS data structure for callback interface and call <a class="el" href="group___c_o_m_p_o_n_e_n_t___h_o_s_t.html#gab25f602a508c0fd5de3885f0ec21b459">CM_BindComponentToUser</a>.</li>
<li>CM proxy which implements <a class="el" href="group___c_o_m_p_o_n_e_n_t___h_o_s_t.html#gab25f602a508c0fd5de3885f0ec21b459">CM_BindComponentToUser</a>, allocated the skeleton structure and call <a class="el" href="group___c_m___o_s___a_p_i.html#ga63dde147017d6dfd5a0e3aba9f465b8c">CM_OS_BindComponentToCMCore</a>. This call potentially travel user to kernel space boundaries.</li>
<li>The OS which implements <a class="el" href="group___c_m___o_s___a_p_i.html#ga63dde147017d6dfd5a0e3aba9f465b8c">CM_OS_BindComponentToCMCore</a>, allocated wrapper data strucutre and call <a class="el" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga1afc1b859105582f9311cf921fa58dcb">CM_ENGINE_BindComponentToCMCore</a>.</li>
<li>The CM engine which implements <a class="el" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga1afc1b859105582f9311cf921fa58dcb">CM_ENGINE_BindComponentToCMCore</a>, allocate the fifo params. Note that fifo coms was allocated at boot time.</li>
</ul>
<h2><a class="anchor" id="MPC2HOST_Code">
OS integration example codes</a></h2>
<p>Ther following code is gived as example. It show how wrap CM Syscall API and put in place data structure show on previous figure. Furthermore, it show how upsending event to client.</p>
<p>This code show wrapper data structure: </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;cm/engine/inc/cm_syscall.h&gt;</span>

<span class="keyword">typedef</span> <span class="keyword">struct </span>{
  <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga0be7300027f1938afa8892251d4a688d" title="Component manager handle to MPC -&amp;gt; Host communication.">t_cm_bf_mpc2host_handle</a>        mpc2hostId;
  <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga1b8a5a109b021ac7d182ce1bda1d9130" title="Component manager proxy handle to MPC -&amp;gt; Host skeleton context.">t_nmf_mpc2host_handle</a>          upperLayerThis;
  <span class="keywordtype">void</span>                           *msgQueue;
} t_skelwrapper;
</pre></div><p>This code show an implementation of <a class="el" href="group___c_m___o_s___a_p_i.html#ga63dde147017d6dfd5a0e3aba9f465b8c">CM_OS_BindComponentToCMCore</a> that create a wrapper data structure: </p>
<div class="fragment"><pre class="fragment"><a class="code" href="group__t__cm__error.html#ga0c6e4897ef6a9f579c3dcac1b697141b" title="Error type returned by CM API routines.">t_cm_error</a> <a class="code" href="group___c_m___o_s___a_p_i.html#ga63dde147017d6dfd5a0e3aba9f465b8c" title="Bind a component to the Host.">CM_OS_BindComponentToCMCore</a>(
        <span class="keyword">const</span> <a class="code" href="group___n_m_f___c_o_m_m_o_n.html#gaf56804f9ea17419da09cb1d6884e82dc" title="Common Nomadik Multiprocessing Framework type definition.">t_cm_instance_handle</a> client,
        <span class="keyword">const</span> <span class="keywordtype">char</span>* requiredItfClientName,
        <a class="code" href="group___n_m_f___p_r_i_m_i_t_i_v_e___t_y_p_e.html#ga5543ed798da376a99db035f6ae6aaa1f" title="Unsigned 32 bits primitive type.">t_uint32</a> fifosize,
        <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga1b8a5a109b021ac7d182ce1bda1d9130" title="Component manager proxy handle to MPC -&amp;gt; Host skeleton context.">t_nmf_mpc2host_handle</a> upLayerThis,
        <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga0be7300027f1938afa8892251d4a688d" title="Component manager handle to MPC -&amp;gt; Host communication.">t_cm_bf_mpc2host_handle</a>* mpc2hostId,
        <span class="keyword">const</span> <span class="keywordtype">char</span>** requiretype,
        <a class="code" href="group___n_m_f___p_r_i_m_i_t_i_v_e___t_y_p_e.html#ga5543ed798da376a99db035f6ae6aaa1f" title="Unsigned 32 bits primitive type.">t_uint32</a>* methodNumber) 
{
    <a class="code" href="group__t__cm__error.html#ga0c6e4897ef6a9f579c3dcac1b697141b" title="Error type returned by CM API routines.">t_cm_error</a> error;   
    t_skelwrapper *skelwrapper;
                
    skelwrapper = (t_skelwrapper *)malloc(<span class="keyword">sizeof</span>(t_skelwrapper));
    <span class="keywordflow">if</span>(skelwrapper == 0)
        <span class="keywordflow">return</span> <a class="code" href="group__t__cm__error.html#gab88ec56824c212efaf950118edb62963" title="NMF_NO_MORE_MEMORY">CM_NO_MORE_MEMORY</a>;
        
    <span class="keywordflow">if</span>((error = <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga1afc1b859105582f9311cf921fa58dcb" title="Bind a component to the Host, see CM_ENGINE_BindComponentToCMCore.">CM_ENGINE_BindComponentToCMCore</a>(
            client, requiredItfClientName,
            fifosize,
            (<a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga1b8a5a109b021ac7d182ce1bda1d9130" title="Component manager proxy handle to MPC -&amp;gt; Host skeleton context.">t_nmf_mpc2host_handle</a>)skelwrapper,
            mpc2hostId, requiretype, methodNumber)) != <a class="code" href="group__t__cm__error.html#gad5549292faf7b24aa21305650631fdcc" title="NMF_OK">CM_OK</a>) {
        free(skelwrapper);
        <span class="keywordflow">return</span> error;
    }

    skelwrapper-&gt;upperLayerThis = upLayerThis;
    skelwrapper-&gt;mpc2hostId = *mpc2hostId;
    skelwrapper-&gt;msgQueue = get_Msg_Queue_Associated_With_This_Thread();
    
    <span class="keywordflow">return</span> <a class="code" href="group__t__cm__error.html#gad5549292faf7b24aa21305650631fdcc" title="NMF_OK">CM_OK</a>;
}
</pre></div><p>And this code show an implementation of <a class="el" href="group___c_m___o_s___a_p_i.html#ga70987480470543c0b689f75db94dca00">CM_OS_UnbindComponentToCMCore</a> that destroy a wrapper data structure: </p>
<div class="fragment"><pre class="fragment"><a class="code" href="group__t__cm__error.html#ga0c6e4897ef6a9f579c3dcac1b697141b" title="Error type returned by CM API routines.">t_cm_error</a> <a class="code" href="group___c_m___o_s___a_p_i.html#ga70987480470543c0b689f75db94dca00" title="Unbind a component to the Host.">CM_OS_UnbindComponentToCMCore</a>(
        <span class="keyword">const</span> <a class="code" href="group___n_m_f___c_o_m_m_o_n.html#gaf56804f9ea17419da09cb1d6884e82dc" title="Common Nomadik Multiprocessing Framework type definition.">t_cm_instance_handle</a>      client,
        <span class="keyword">const</span> <span class="keywordtype">char</span>                      *requiredItfClientName,
        <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga1b8a5a109b021ac7d182ce1bda1d9130" title="Component manager proxy handle to MPC -&amp;gt; Host skeleton context.">t_nmf_mpc2host_handle</a>           *upLayerThis) {
    <a class="code" href="group__t__cm__error.html#ga0c6e4897ef6a9f579c3dcac1b697141b" title="Error type returned by CM API routines.">t_cm_error</a> error;
    t_skelwrapper *skelwrapper;
    
    <span class="keywordflow">if</span>((error = <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga0e8b9e4063bdb6c3e2b37cebd53ac919" title="Unbind a component to the Host, see CM_ENGINE_UnbindComponentToCMCore.">CM_ENGINE_UnbindComponentToCMCore</a>(
        client, requiredItfClientName, (<a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga1b8a5a109b021ac7d182ce1bda1d9130" title="Component manager proxy handle to MPC -&amp;gt; Host skeleton context.">t_nmf_mpc2host_handle</a>*)&amp;skelwrapper)) != <a class="code" href="group__t__cm__error.html#gad5549292faf7b24aa21305650631fdcc" title="NMF_OK">CM_OK</a>) {
        <span class="keywordflow">return</span> error;        
    }
   
    *upLayerThis = skelwrapper-&gt;upLayerThis;
    
    free(skelwrapper);
    
    <span class="keywordflow">return</span> <a class="code" href="group__t__cm__error.html#gad5549292faf7b24aa21305650631fdcc" title="NMF_OK">CM_OK</a>;
}
</pre></div><p>This code show element data structure used for enqueue incoming event. </p>
<div class="fragment"><pre class="fragment"><span class="keyword">typedef</span> <span class="keyword">struct </span>{
    t_skelwrapper                 *skelwrapper;
    <a class="code" href="group___n_m_f___p_r_i_m_i_t_i_v_e___t_y_p_e.html#ga5543ed798da376a99db035f6ae6aaa1f" title="Unsigned 32 bits primitive type.">t_uint32</a>                      methodIndex;
    <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#gacb472f3bf94f3cac513a65ff8520ce66" title="Communication Component Manager API type.">t_event_params_handle</a>         anyPtr;
    <a class="code" href="group___n_m_f___p_r_i_m_i_t_i_v_e___t_y_p_e.html#ga5543ed798da376a99db035f6ae6aaa1f" title="Unsigned 32 bits primitive type.">t_uint32</a>                      ptrSize;
} t_queueelem;
</pre></div><p>This code show an an implementation of postDfc method in OSAL used by CM Engine to post event. The main purpose it to enqueue the event in the process queue that create the MPC-&gt;Host or MPC-&gt;User binding. </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> PostDfc(
        <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga1b8a5a109b021ac7d182ce1bda1d9130" title="Component manager proxy handle to MPC -&amp;gt; Host skeleton context.">t_nmf_mpc2host_handle</a> upLayerTHIS, 
        <a class="code" href="group___n_m_f___p_r_i_m_i_t_i_v_e___t_y_p_e.html#ga5543ed798da376a99db035f6ae6aaa1f" title="Unsigned 32 bits primitive type.">t_uint32</a>              methodIndex, 
        <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#gacb472f3bf94f3cac513a65ff8520ce66" title="Communication Component Manager API type.">t_event_params_handle</a> anyPtr, 
        <a class="code" href="group___n_m_f___p_r_i_m_i_t_i_v_e___t_y_p_e.html#ga5543ed798da376a99db035f6ae6aaa1f" title="Unsigned 32 bits primitive type.">t_uint32</a>              ptrSize)
{
    t_skelwrapper *skelwrapper = (t_skelwrapper *)upLayerTHIS;
    t_queueelem elem;
        
    elem.skelwrapper = t_skelwrapper;
    elem.methodIndex = methodIndex;
    elem.anyPtr = anyPtr;
    elem.ptrSize = ptrSize;

    skelwrapper-&gt;msgQueue-&gt;enQueue(&amp;elem);
}
</pre></div><p>This code show an implementation of method to get an waited event. This method must be call from the task that dispatch event running inside the client process. </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;cm/common/communication/inc/stub_wrapper.h&gt;</span>

<span class="keywordtype">void</span> GetEvent(
        <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga1b8a5a109b021ac7d182ce1bda1d9130" title="Component manager proxy handle to MPC -&amp;gt; Host skeleton context.">t_nmf_mpc2host_handle</a>        *upLayerThis
        <a class="code" href="group___n_m_f___p_r_i_m_i_t_i_v_e___t_y_p_e.html#ga5543ed798da376a99db035f6ae6aaa1f" title="Unsigned 32 bits primitive type.">t_uint32</a>                     *methodIndex,
        <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#gacb472f3bf94f3cac513a65ff8520ce66" title="Communication Component Manager API type.">t_event_params_handle</a>        anyPtr) 
{
    t_queueelem elem;
    
    get_Msg_Queue_Associated_With_This_Thread()-&gt;deQueue(&amp;elem);
    
    *upLayerThis = elem.skelwrapper-&gt;upperLayerThis;
    *methodIndex = elem.methodIndex;
    Copy_Buffer_To_User_Space(anyPtr, elem.anyPtr, elem.ptrSize); <span class="comment">// elem.anyPtr (in kernel space) -&gt; anyPtr (in user space)</span>
    
    <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga00909bfd4c818df7d9eef6e06d4ba869" title="Aknowledge a Fifo that the received event has been demarshalled.">CM_ENGINE_AcknowledgeEvent</a>(elem.skelwrapper-&gt;mpc2hostId);
}
</pre></div><p>This code show an implementation of active task that wait dispatch event running inside the client process. Note that this task do active polling for example, but wait-notify protocol must be used for real implementation. </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;cm/common/communication/inc/stub_wrapper.h&gt;</span>

<span class="keywordtype">void</span> HandleEvent() 
{
    <span class="keywordflow">do</span> {
        <a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#ga1b8a5a109b021ac7d182ce1bda1d9130" title="Component manager proxy handle to MPC -&amp;gt; Host skeleton context.">t_nmf_mpc2host_handle</a> skeleton;
        <a class="code" href="group___n_m_f___p_r_i_m_i_t_i_v_e___t_y_p_e.html#ga5543ed798da376a99db035f6ae6aaa1f" title="Unsigned 32 bits primitive type.">t_uint32</a> methodIndex;
        <span class="keywordtype">char</span> anyPtr[1024]; <span class="comment">// Max maximum size!!</span>
        
        GetEvent(&amp;skeleton, &amp;methodIndex, (<a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#gacb472f3bf94f3cac513a65ff8520ce66" title="Communication Component Manager API type.">t_event_params_handle</a>)anyPtr);
        
        CM_CALLBACK_CallSkeleton(skeleton, methodIndex, (<a class="code" href="group___c_m___e_n_g_i_n_e___a_p_i.html#gacb472f3bf94f3cac513a65ff8520ce66" title="Communication Component Manager API type.">t_event_params_handle</a>)anyPtr);
    } <span class="keywordflow">while</span>(1);
} 
</pre></div> </div>
<hr size="1">
<address style="align: right;"><small> 
<b>NMF Host Execution Engine Documentation</b> generated by <a href="http://www.doxygen.org">doxygen</a> 1.6.3 on 28 Oct 2011
</small></address>
<address style="align: right;"><small>
Copyright 2006-2009 <a href="http://www.stericsson.com"><b>ST-Ericsson</b></a>
 - Confidential document - Unauthorized reproduction and communication strictly prohibited
</small></address>
</body>
</html>
