/*************************************************************************
 * Copyright ST-Ericsson 2010
 ************************************************************************/
#include <cops_common.h>
#include <cops_storage.h>
#include <sys/stat.h>
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>

#ifdef COPS_IN_LOADERS
/*
 * Autogenerated file included through r_fsu.h.
 * Needed here so that make dependencies are correct.
 * They are missed by SDE because r_fsu.h is also autogenerated
 */
#include <error_codes.h>
#include <r_fsu.h>
#define cops_file_open(a, b, c) OS_Free_Open_File(a, b, c)
#define cops_file_read(a, b, c) OS_Free_Read_File(a, (char *)(b), c)
#define cops_file_close(a) OS_Free_Close_File(a)
#define cops_file_write(a, b, c) OS_Free_Write_File(a, (const char *)(b), c)
#define cops_file_rename(a, b) OS_Free_Rename(a, b)
#else
#ifdef COPS_OSE_ENVIRONMENT
#include <r_os.h>
#endif /* COPS_OSE_ENVIRONMENT */
#define cops_file_open(a, b, c) open(a, b, c)
#define cops_file_read(a, b, c) read(a, (char *)(b), c)
#define cops_file_close(a) close(a)
#define cops_file_write(a, b, c) write(a, (const char *)(b), c)
#define cops_file_rename(a, b) rename(a, b)
#endif /* COPS_IN_LOADERS */

#ifndef COPS_DATA_0
#define COPS_DATA_0 "COPS_DATA_0.csd"
#endif

#ifndef PERM_AUTH_STATE_DATA_0
#define PERM_AUTH_STATE_DATA_0 "PERM_AUTH_STATE_DATA_0.csd"
#endif

#define MAX_PATH_LENGTH 256

cops_return_code_t cops_storage_read(cops_data_t *cd,
                                     enum cops_data_type data_type)
{
    cops_return_code_t ret_code = COPS_RC_OK;
    char filename[MAX_PATH_LENGTH];
    int       fd = -1;
    ssize_t   res;

    if (cd->data == NULL) {
        COPS_LOG(LOG_ERROR, "ERROR cd not initialized\n");
        ret_code = COPS_RC_ARGUMENT_ERROR;
        goto function_exit;
    }

    if (COPS_DATA == data_type) {
        strncpy(filename, STR(COPS_STORAGE_DIR) COPS_DATA_0, MAX_PATH_LENGTH);
    } else if (PERM_AUTH_STATE_DATA == data_type) {
        strncpy(filename, STR(COPS_STORAGE_DIR) PERM_AUTH_STATE_DATA_0,
                MAX_PATH_LENGTH);
    } else {
        COPS_SET_RC(COPS_RC_ARGUMENT_ERROR, "Unsupported data type\n");
    }

    /* Third argument 0 is only needed for loaders to build. It is not used */
    fd = cops_file_open(filename, O_RDONLY, 0);

    if (fd == -1) {
        COPS_LOG(LOG_ERROR, "cops_file_open(\"%s\"): %s\n",
                 filename, strerror(errno));
        ret_code = COPS_RC_STORAGE_ERROR;
        goto function_exit;
    }

    cd->length = 0;

    for (;;) {
        if (cd->length >= cd->max_length) {
            COPS_LOG(LOG_ERROR, "\"%s\" is too large (larger than %d)\n",
                     filename, (int)cd->max_length);
            ret_code = COPS_RC_STORAGE_ERROR;
            goto function_exit;
        }

        res = cops_file_read(fd, cd->data + cd->length,
                             cd->max_length - cd->length);

        if (res == -1) {
            if (errno == EINTR) {
                continue;
            }

            COPS_LOG(LOG_ERROR, "cops_file_read(%d, x, %d): %s\n",
                     fd, (int)(cd->max_length - cd->length), strerror(errno));
            ret_code = COPS_RC_STORAGE_ERROR;
            goto function_exit;
        }

        if (res == 0) {
            break;    /* reached end of file */
        }

        cd->length += res;
    }
    /*lint -e557 Suppress unrecognized format %zu which is used in Linux */
    COPS_LOG(LOG_INFO, "read \"%s\" (%zu bytes)\n", filename, cd->length);
    /*lint +e557 */

function_exit:

    if (fd != -1) {
        (void)cops_file_close(fd);
    }

    return ret_code;
}

cops_return_code_t cops_storage_write(cops_data_t *cd,
                                      enum cops_data_type data_type)
{
    cops_return_code_t ret_code = COPS_RC_OK;
    int       fd = -1;
    ssize_t   res;
    size_t    num_written;
    char      file_name[] = STR(COPS_STORAGE_DIR) COPS_DATA_0 "XXXXXX";
    char      real_file_name[MAX_PATH_LENGTH];

    if (cd->data == NULL) {
        COPS_LOG(LOG_ERROR, "ERROR cd not initialized\n");
        ret_code = COPS_RC_ARGUMENT_ERROR;
        goto function_exit;
    }

    if (COPS_DATA == data_type) {
        strncpy(real_file_name, STR(COPS_STORAGE_DIR) COPS_DATA_0,
                MAX_PATH_LENGTH);
    } else if (PERM_AUTH_STATE_DATA == data_type) {
        strncpy(real_file_name, STR(COPS_STORAGE_DIR) PERM_AUTH_STATE_DATA_0,
                MAX_PATH_LENGTH);
    } else {
        COPS_SET_RC(COPS_RC_ARGUMENT_ERROR, "Unsupported data type\n");
    }

#ifdef COPS_OSE_ENVIRONMENT
    {
#ifndef COPS_IN_LOADERS
        (void)set_env(CURRENT_PROC(), "EFS_TMPDIR", STR(COPS_STORAGE_DIR));

        char *p = tmpnam(file_name);
        if (p == NULL) {
            /* simulate error */
            fd = -1;
            ret_code = COPS_RC_STORAGE_ERROR;
            goto function_exit;
        }
#endif

        fd = cops_file_open(file_name, O_RDWR | O_CREAT, S_IRUSR | S_IWUSR);
    }
#else
    fd = mkstemp(file_name);
#endif

    if (fd == -1) {
        COPS_LOG(LOG_ERROR, "mkstemp(\"%s\"): %s\n",
                 file_name, strerror(errno));
        ret_code = COPS_RC_STORAGE_ERROR;
        goto function_exit;
    }

#ifndef COPS_OSE_ENVIRONMENT
    if (fchmod(fd, 0644) == -1) {
        COPS_LOG(LOG_ERROR, "fchmod(%d, 0x644): %s\n", fd, strerror(errno));
        ret_code = COPS_RC_STORAGE_ERROR;
        goto function_exit;
    }
#endif

    for (num_written = 0; num_written < cd->length;) {
        res = cops_file_write(fd, cd->data + num_written,
                              cd->length - num_written);

        if (res == -1) {
            if (errno == EINTR) {
                continue;
            }

            COPS_LOG(LOG_ERROR, "cops_file_write(%d, x, %d): %s\n",
                     fd, (int)(cd->length - num_written), strerror(errno));
            ret_code = COPS_RC_STORAGE_ERROR;
            goto function_exit;
        }

        num_written += res;
    }

    if (cops_file_close(fd) == -1) {
        COPS_LOG(LOG_ERROR, "cops_file_close(%d): %s\n", fd, strerror(errno));
        ret_code = COPS_RC_STORAGE_ERROR;
        goto function_exit;
    }
    fd = -1;

    if (cops_file_rename(file_name, real_file_name) != 0) {
        COPS_LOG(LOG_ERROR, "cops_file_rename(\"%s\", \"%s\"): %s\n",
                 file_name, real_file_name, strerror(errno));
        ret_code = COPS_RC_STORAGE_ERROR;
        goto function_exit;
    }
    /*lint -e557 Suppress unrecognized format %zu which is used in Linux */
    COPS_LOG(LOG_INFO, "written \"%s\" (%zu bytes)\n",
             real_file_name, cd->length);
    /*lint +e557 */

function_exit:

    if (fd != -1) {
        (void)cops_file_close(fd);
    }

    (void)unlink(file_name);
    return ret_code;
}
